// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model Role {
  id   String @id @default(uuid()) //PK	Unique identifier for each role
  name String //-	Role name (e.g., "USER", "ADMIN")
  users User[] //-	Relation to the User model
}
model Autorization {
  id        String   @id @default(uuid()) //PK	Unique identifier for each authorization
  userId    String   //FK	The ID of the user
  resource  String   //-	The resource being accessed
  action    String   //-	The action being performed (e.g., "CREAT", "READ", "UPDATE", "DELETE" )
  allowed   Boolean  //-	Whether the action is allowed
  createdAt DateTime //-	Timestamp of when the authorization was created
  updatedAt DateTime //-	Timestamp of the last update to the authorization

  users User[]
} 

////////////////////////////////////
/////   Table auth et user   ///////
////////////////////////////////////

model User {
id	String	@id @default(uuid()) //PK	Unique identifier for each user
name	String	//-	User's chosen display name
email	String	//-	User's email address for communication and login
emailVerified	Boolean	//-	Whether the user's email is verified
image	String?	//User's image url
createdAt DateTime	//-	Timestamp of when the user account was created
updatedAt	DateTime	//-	Timestamp of the last update to the user's information
roles Role[]	//-	Roles assigned to the user (e.g., USER, ADMIN)
sessions Session[]	//-	Relation to the Session model
accounts Account[]	//-	Relation to the Account model
profiles Profile[]

autorizations Autorization[]
}

model Session {
id	String	@id @default(uuid()) //PK	Unique identifier for each session
userId	String	//FK	The ID of the user
token	String	//-	The unique session token
expiresAt	DateTime	//-	The time when the session expires
ipAddress	String?	//The IP address of the device
userAgent	String?	//The user agent information of the device
createdAt	DateTime	//-	Timestamp of when the session was created
updatedAt	DateTime	//-	Timestamp of when the session was updated

users User[]
}
model Account {

id	String @id @default(uuid())	//PK	Unique identifier for each account
userId	String	//FK	The ID of the user
accountId	String	//-	The ID of the account as provided by the SSO or equal to userId for credential accounts
providerId	String	//-	The ID of the provider
accessToken	String	?	//The access token of the account. Returned by the provider
refreshToken	String	?	//The refresh token of the account. Returned by the provider
accessTokenExpiresAt	DateTime?	//The time when the access token expires
refreshTokenExpiresAt	DateTime?	//The time when the refresh token expires
scope	String?	//The scope of the account. Returned by the provider
idToken	String?	//The ID token returned from the provider
password	String?	//The password of the account. Mainly used for email and password authentication
createdAt	DateTime	//-	Timestamp of when the account was created
updatedAt	DateTime	//-	Timestamp of when the account was updated

users User[]
}

model Verificationerification {
id	String @id @default(uuid())	//PK	Unique identifier for each verification
identifier	String	//-	The identifier for the verification request
value	String	//-	The value to be verified
expiresAt	DateTime	//-	The time when the verification request expires
createdAt	DateTime	//-	Timestamp of when the verification request was created
updatedAt	DateTime	//-	Timestamp of when the verification request was updated
}

model Profile {
  id        String   @id @default(uuid())
  userId    String   @unique
  bio       String?
  avatarUrl String?
  website   String?
  location  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])
}   

/////////////////////////////
//////   Table Galina   /////
/////////////////////////////

model Galina {
  id            Int      @id @default(autoincrement())
  nom          String
  order   Int?
  description String?
  image   String?
  tags  String?
  type String? // batterie / plein air / Bio
  difficulte     String?
  memo String?         
}

model Kpi {// taux de ponte, ponte oeufs, poids moyen oeufs, consommation alimentaire, taux de conversion alimentaire, production par m2
  id            Int      @id @default(autoincrement())
  nom          String
  order   Int?
  description String?
  valeurCible Float?
  valeurActuelle Float?
  dateMesure DateTime?
  frequenceSuivi String? // journalier / hebdomadaire / mensuel / trimestriel
  memo String?         
} 



//////////////////////////////
//////   Table Culture   /////
//////////////////////////////
	model Culture {
	  id             Int      @id @default(autoincrement())
	  nom            String
	  order   Int?
	  note Int?
	  variete        String?
	image   String?
	tags  String?
	description String?
	  cycle      String?
	  prixVenteB2B  String?    // en euros/kg
	coutProd  String?
	  temperature  String?
	  ensoleillement String?      // heures/jour
	  besoinEau      String ?    // mm/mois
	ph  String?
	 fertilisation  String?
	type String? // plein champ et / ou hydroponie
	 rendement      Float?    // kg/m2/an
	  difficulte     String?
	memo String?
	  @@map("cultures")
	}

//////////////////////////////
//////  Table Recette   //////
//////////////////////////////
model Category{
  id                 String               @id @default(uuid())
  name               String
  description        String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  classes           Class[]
  @@map("categories")
}
model Class{
  id                 String               @id @default(uuid())
  name               String
  description        String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  categories        Category[]
  subclasses        SubClass[]
  @@map("classes")
  
}
model SubClass{
  id                 String               @id @default(uuid())
  name               String
  classId          String
  classes Class[]
  description        String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  
  @@map("subcategories")

}
model Recette {
  id                 String               @id @default(uuid())
  name               String
  carte           String?              // Référence à une carte (menu)
  order             Int?
  coutPreparation     Float
  tempsPreparation   Int                  // en minutes
  description        String
  image              String?
  tags               String[]             // ["végétarien", "épicé", "sans gluten"]
  categorie          String               // "ENTREE", "PLAT", "DESSERT", "BOISSON"
  prixVente         Float
  etapes             String[]
  ingredientsRecipes RecetteIngredient[]
  estActif          Boolean              @default(true)
  commandeItems      CommandeItem[]
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  
  @@map("recettes")
}

model Ingredient {
  id           String               @id @default(uuid())
  name         String
  order       Int?
  description  String?
  stockActuel  Float                @default(0)
  stockMinimum Float                @default(10)
  unite        String               // "kg", "L", "pièce", "g"
  prixAchatMoyen Float?             // Prix d'achat moyen pondéré
  fournisseurPrincipalId String?    // Référence au fournisseur principal
  fournisseurPrincipal Fournisseur? @relation(fields: [fournisseurPrincipalId], references: [id])
  recettes     RecetteIngredient[]
  mouvements   MouvementStock[]
  prixFournisseurs PrixIngredientFournisseur[]
  estActif     Boolean              @default(true)
  
  @@map("ingredients")
  itemCommandeFournisseurs ItemCommandeFournisseur[]
}

model RecetteIngredient {
  id           String    @id @default(uuid())
  recette      Recette   @relation(fields: [recetteId], references: [id])
  recetteId    String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  ingredientId String
  quantite     Float
  unite        String
  
  @@map("recette_ingredients")
}

//////////////////////////////
//////  GESTION STOCKS  //////
//////////////////////////////

model MouvementStock {
  id           String    @id @default(uuid())
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  ingredientId String
  type         String    // "ENTREE", "SORTIE", "INVENTAIRE", "AJUSTEMENT"
  quantite     Float
  prixUnitaire Float?    // Prix d'achat pour les entrées
  fournisseurId String?  // Fournisseur pour les entrées
  fournisseur  Fournisseur? @relation(fields: [fournisseurId], references: [id])
  motif        String?   // "achat", "preparation", "inventaire", "perte"
  date         DateTime  @default(now())
  utilisateur  String?
  
  @@map("mouvements_stock")
}

//////////////////////////////
//////  FOURNISSEURS   //////
//////////////////////////////

model Fournisseur {
  id          String      @id @default(uuid())
  nom         String
  order      Int?
  type        String      // "LEGUMES", "VIANDES", "POISSONS", "EPICERIE", "BOISSONS"
  contact     String?
  telephone   String?
  email       String?
  adresse     String?
  ville       String?
  codePostal  String?
  pays        String      @default("France")
  note        Int?        // Note de 1 à 5
  conditionsPaiement String? // "30 jours", "comptant", "50% acompte"
  delaiLivraison Int?     // Délai en jours
  estActif    Boolean     @default(true)
  
  // Relations
  ingredientsPrincipaux Ingredient[] // Ingredients où il est fournisseur principal
  prixIngredientFournisseurs PrixIngredientFournisseur[]
  mouvementsStock MouvementStock[]
  commandesFournisseur CommandeFournisseur[]
  
  @@map("fournisseurs")
}

// Table de liaison pour les prix par fournisseur
model PrixIngredientFournisseur {
  id           String    @id @default(uuid())
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  ingredientId String
  fournisseur  Fournisseur @relation(fields: [fournisseurId], references: [id])
  fournisseurId String
  prix         Float     // Prix unitaire
  unite        String    // Unité de vente ("kg", "L", "caisse", "pièce")
  conditionnement String? // "sac 25kg", "caisse 12 bouteilles"
  devise       String    @default("EUR")
  dateDebut    DateTime  @default(now())
  dateFin      DateTime? // Pour historiser les prix
  estActif     Boolean   @default(true)
  note         String?   // "Prix promotionnel", "Contrat annuel"
  
  // Contraintes d'unicité
  @@unique([ingredientId, fournisseurId, estActif], name: "prix_actif_unique")
  @@unique([ingredientId, fournisseurId, dateDebut], name: "prix_date_unique")
  
  @@map("prix_ingredient_fournisseurs")
  itemCommandeFournisseurs ItemCommandeFournisseur[]
}

//////////////////////////////
////// COMMANDES FOURNISSEUR //////
//////////////////////////////

model CommandeFournisseur {
  id          String         @id @default(uuid())
  numero      String         @unique // "CMD-FOURN-2024-001"
  fournisseur Fournisseur    @relation(fields: [fournisseurId], references: [id])
  fournisseurId String
  statut      String         // "BROUILLON", "EN_ATTENTE", "CONFIRMEE", "LIVREE", "ANNULEE"
  dateCommande DateTime      @default(now())
  dateLivraisonPrevue DateTime?
  dateLivraisonReelle DateTime?
  montantTotal Float
  items       ItemCommandeFournisseur[]
  note        String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  @@map("commandes_fournisseur")
}

model ItemCommandeFournisseur {
  id          String    @id @default(uuid())
  commande    CommandeFournisseur @relation(fields: [commandeId], references: [id])
  commandeId  String
  ingredient  Ingredient @relation(fields: [ingredientId], references: [id])
  ingredientId String
  quantite    Float
  unite       String
  prixUnitaire Float
  prixReference PrixIngredientFournisseur? @relation(fields: [prixReferenceId], references: [id])
  prixReferenceId String?
  
  @@map("items_commande_fournisseur")
}

//////////////////////////////
//////  COMMANDES CLIENT  //////
//////////////////////////////

model Commande {
  id          String         @id @default(uuid())
  numero      String         @unique
  client      String?
  statut      String
  type        String
  items       CommandeItem[]
  total       Float
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  @@map("commandes")
}

model CommandeItem {
  id          String   @id @default(uuid())
  commande    Commande @relation(fields: [commandeId], references: [id])
  commandeId  String
  recette     Recette  @relation(fields: [recetteId], references: [id])
  recetteId   String
  quantite    Int      @default(1)
  prixUnitaire Float
  commentaire String?
  
  @@map("commande_items")
}
//////////////////////////
/////   models Dev   /////
//////////////////////////

model Dev {
  id         Int      @id @default(autoincrement())
  name       String
  type       String
  content    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  parentId   Int?              // Référence facultative au parent
  parent     Dev?     @relation("DevRelation", fields: [parentId], references: [id])
  children   Dev[]    @relation("DevRelation")

}
